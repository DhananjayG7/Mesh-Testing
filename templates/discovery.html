<!DOCTYPE html>
<html>
<head>
  <title>Device Discovery Network</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    .device { padding: 10px; border: 1px solid #ccc; margin: 5px 0; border-radius: 6px; }
    .online { background: #d4ffd4; }
    .offline { background: #ffd4d4; }
    button { padding: 8px 12px; margin-top: 10px; }
  </style>
</head>
<body>

<h2>ğŸ” Device Network Discovery</h2>

<button onclick="discover()">Scan for Devices</button>
<button onclick="saveNetwork()">Save Network</button>

<div id="deviceList"></div>

<script>
let devices = [];

async function discover() {
  document.getElementById("deviceList").innerHTML = "Scanning...";
  let res = await fetch("/api/discover_now");
  let data = await res.json();

  devices = data.devices || [];
  let html = "";

  devices.forEach(d => {
    let last = (Date.now()/1000) - d.last_seen;
    let isOnline = last < 5; // active in last 5 sec
    html += `
      <div class="device ${isOnline ? "online" : "offline"}">
        <input type="checkbox" value="${d.ip}" />
        <b>${d.ip}</b> - ${isOnline ? "ğŸŸ¢ Online" : "ğŸ”´ Offline"}
        <br/>
        <small>Last Seen: ${last.toFixed(1)} sec ago</small>
      </div>`;
  });

  document.getElementById("deviceList").innerHTML = html;
}

async function saveNetwork() {
  let selected = [...document.querySelectorAll("input[type=checkbox]:checked")].map(i => i.value);

  await fetch("/api/save_mesh_devices", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({devices: selected})
  });

  alert("âœ… Network Saved: " + selected.join(", "));
}

discover();
</script>

</body>
</html>
