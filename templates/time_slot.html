{% extends "base.html" %}

{% block title %}Time Slot Master{% endblock %}

{% block page_css %}
body { background:#f9f6ef; font-family:sans-serif;}
.header { display:flex; align-items:center; justify-content:space-between; padding: 18px 32px 0 32px; }
.logo-main { height: 44px; }
.logo-right { height: 34px; }
.container { max-width:600px; margin:40px auto; background:#fff; border-radius:18px; box-shadow:0 4px 24px #20508122; padding:38px 36px 32px 36px;}
h2 { color:#205081; font-weight:700; margin-bottom:28px;}
form label {display:inline-block; width:100px; margin-bottom:8px; color:#205081; font-weight:600;}
form input,form select {width: calc(100% - 110px); margin-bottom:13px; padding:7px 12px; border-radius:8px; border:1px solid #d0dbed;}
form { display: flex; flex-wrap: wrap; align-items:center; margin-bottom:22px;}
form label, form input, form select, form button { margin-right:10px;}
.btn-main { background:#205081; color:#fff; border:none; border-radius:8px; font-weight:600; padding:9px 18px; margin-right:8px; cursor:pointer;}
.btn-main:hover { background:#ffa500; color:#fff;}
.btn-reset { background:#e3e6f0; color:#205081; border:none; border-radius:8px; font-weight:600; padding:9px 16px; cursor:pointer;}
table { width:100%; margin-top:10px; border-collapse:collapse;}
th,td {padding:9px 11px; border-bottom:1.5px solid #f0f0f0; text-align:center;}
th { background:#f4f8fb; color:#205081;}
td button { margin: 0 4px; }
@media (max-width:600px){
  .container {padding: 18px 5vw;}
  form label, form input, form select {width:100%;}
}
{% endblock %}

{% block body %}
<div class="header">
  <button class="btn btn-main" onclick="location.href='/menu'"><i class="fa fa-arrow-left"></i></button>
  <img src="/static/img/logo_company.png" class="logo-main" alt="Logo">
  <img src="/static/img/logo_epitage.png" class="logo-right" alt="Epitage">
</div>

<div class="container">
  <h2>Time Slot Master</h2>
  <form onsubmit="return false;" id="slot-form">
    <label>Shift</label>
    <select id="shift_sel"></select>

    <label>Slot Code</label>
    <input id="slot_code" type="text" inputmode="latin" required maxlength="16">

    <label>Name</label>
    <input id="slot_name" type="text" required>

    <label>From</label>
    <input id="from_time" type="time" inputmode="numeric" required>

    <label>To</label>
    <input id="to_time" type="time" inputmode="numeric" required>

    <button class="btn-main" onclick="addOrUpdateSlot()">Save</button>
    <button class="btn-reset" onclick="resetForm()" type="button">Reset</button>
  </form>

  <table id="slot_table">
    <thead><tr><th>Code</th><th>Name</th><th>Shift</th><th>From</th><th>To</th><th>Action</th></tr></thead>
    <tbody></tbody>
  </table>
</div>
{% endblock %}

{% block scripts %}
<script>
let slots=[],shifts=[],edit_code=null;

function load() {
  fetch('/api/time_slot_master/list').then(r=>r.json()).then(data=>{
    slots = data.slots || [];
    shifts = data.shifts || [];

    const shift_sel = document.getElementById('shift_sel');
    shift_sel.innerHTML = (shifts||[]).map(s=>`<option value="${s.shift_code}">${s.shift_name}</option>`).join('');

    const tbody = document.querySelector("#slot_table tbody");
    tbody.innerHTML = (slots||[]).map(x=>`<tr>
      <td>${x.slot_code}</td>
      <td>${x.slot_name}</td>
      <td>${(shifts.find(s=>s.shift_code==x.shift_code)||{}).shift_name||''}</td>
      <td>${x.from_time}</td>
      <td>${x.to_time}</td>
      <td>
        <button class="btn-main" onclick="edit('${x.slot_code}')">Edit</button>
        <button class="btn-reset" onclick="delSlot('${x.slot_code}')">Delete</button>
      </td>
    </tr>`).join('');
  });
}

function addOrUpdateSlot() {
  const body = {
    slot_code: document.getElementById('slot_code').value.trim(),
    shift_code: document.getElementById('shift_sel').value,
    slot_name: document.getElementById('slot_name').value.trim(),
    from_time: document.getElementById('from_time').value,
    to_time: document.getElementById('to_time').value
  };
  const url = edit_code ? "/api/time_slot_master/update" : "/api/time_slot_master/add";
  if (edit_code) body.slot_code = edit_code;

  fetch(url, {method:"POST", headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)})
    .then(()=>{ edit_code=null; load(); resetForm(); });
}

function edit(code) {
  const x = slots.find(s=>s.slot_code==code);
  if (!x) return;
  document.getElementById('slot_code').value = x.slot_code;
  document.getElementById('slot_code').readOnly = true;
  document.getElementById('slot_name').value = x.slot_name;
  document.getElementById('shift_sel').value = x.shift_code;
  document.getElementById('from_time').value = x.from_time;
  document.getElementById('to_time').value = x.to_time;
  edit_code = x.slot_code;
}

function delSlot(code) {
  if (!confirm("Delete this slot?")) return;
  fetch("/api/time_slot_master/delete", {
    method:"POST", headers:{'Content-Type':'application/json'},
    body: JSON.stringify({slot_code: code})
  }).then(()=>load());
}

function resetForm() {
  document.getElementById('slot-form').reset();
  document.getElementById('slot_code').readOnly = false;
  edit_code = null;
}

window.onload = load;
</script>
{% endblock %}
