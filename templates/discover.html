{% extends "base.html" %}
{% block title %}Device Discovery & Mesh Setup{% endblock %}

{% block page_css %}
<style>
:root{
  --brand: #FFA500;
  --bg: #f9f6ef;
  --card: #ffffff;
  --muted: #666;
  --success: #2e7d32;
  --danger: #c62828;
}

/* layout */
.page-shell {
  height: 100%;
  overflow-y: auto;
  padding: 18px;
  box-sizing: border-box;
  background: var(--bg);
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
}

/* controls */
.btn {
  padding:8px 12px;
  border-radius:8px;
  font-weight:600;
  cursor:pointer;
  border:none;
  background:#fff;
  box-shadow: 0 6px 18px rgba(32,80,129,0.06);
}
.btn-primary { background: var(--brand); color:#fff; }
.btn-ghost { background:transparent; color:var(--brand); border:1px solid rgba(0,0,0,0.06); }

.devices {
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap:12px;
}
.device {
  background:var(--card);
  border-radius:10px;
  padding:12px;
  box-shadow: 0 6px 18px rgba(32,80,129,0.06);
}
.device .row { display:flex; align-items:center; justify-content:space-between; gap:8px; }
.meta { color:var(--muted); font-size:0.92rem; }
.ip { font-weight:700; }

.badge { padding:6px 8px; border-radius:8px; font-weight:700; }
.badge.online { background:#e6f7ea; color:var(--success); }
.badge.offline { background:#fff0f0; color:var(--danger); }

.page-footer { margin-top:14px; color:var(--muted); font-size:0.9rem; }
#activityLog { max-height:160px; overflow:auto; background:#fff; border-radius:6px; padding:8px; margin-top:8px; }
</style>
{% endblock %}

{% block body %}
<div class="page-shell">
  <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px;">
    <div style="display:flex; gap:12px; align-items:center;">
      <button onclick="history.back()" class="btn btn-ghost">← Menu</button>
      <div>
        <div style="font-weight:800; font-size:1.05rem;">Device Discovery & Mesh</div>
        <div style="color:#555; font-size:0.92rem;">Select devices to include in your mesh network. Self IP is excluded automatically.</div>
      </div>
    </div>

    <div style="display:flex; gap:8px; align-items:center;">
      <button id="btnScan" class="btn">Scan</button>
      <button id="btnSave" class="btn btn-primary">Save Network</button>
      <label style="display:flex; align-items:center; gap:6px; font-weight:600;">
        <input id="autoRefresh" type="checkbox" checked /> Auto
      </label>
    </div>
  </div>

  <div style="display:flex; gap:12px; margin-bottom:12px; align-items:center;">
    <input id="filterIp" placeholder="Filter by IP or name..." style="flex:1; padding:8px; border-radius:8px; border:1px solid #eee; background:#fff;" />
    <div style="display:flex; gap:8px;">
      <button id="btnSelectAll" class="btn">Select All</button>
      <button id="btnClear" class="btn">Clear</button>
    </div>
  </div>

  <div style="display:flex; gap:12px; margin-bottom:12px;">
    <div style="padding:10px 12px; background:#fff; border-radius:8px;">
      <div id="savedCount" style="font-weight:800;">Saved: 0</div>
      <div style="color:var(--muted);">Selected devices in saved mesh</div>
    </div>
    <div style="padding:10px 12px; background:#fff; border-radius:8px;">
      <div id="knownCount" style="font-weight:800;">Known: 0</div>
      <div style="color:var(--muted);">Devices discovered</div>
    </div>
    <div style="padding:10px 12px; background:#fff; border-radius:8px;">
      <div id="selfIp" style="font-weight:800;">You: --</div>
      <div style="color:var(--muted);">Local device IP</div>
    </div>
  </div>

  <div class="devices" id="deviceList"></div>

  <div class="page-footer">
    <div>
      <b>How it works:</b>
      <ul>
        <li>Select devices and press <i>Save Network</i>. Your device will notify each selected peer.</li>
        <li>Saved devices will receive register/login/delete events reliably via UDP queue.</li>
      </ul>
    </div>

    <div style="margin-top:10px;">
      <b>Activity:</b>
      <div id="activityLog"></div>
    </div>
  </div>
</div>

<script>
/* Discover page JS: uses endpoints:
   - GET /api/discover_now
   - GET /api/devices
   - GET /api/saved_mesh
   - POST /api/save_mesh_devices
   - GET /api/my_ip (optional)
*/

(function () {
  const deviceListEl = document.getElementById('deviceList');
  const savedCount = document.getElementById('savedCount');
  const knownCount = document.getElementById('knownCount');
  const activityLog = document.getElementById('activityLog');
  const selfIpEl = document.getElementById('selfIp');
  const filterInput = document.getElementById('filterIp');

  let discovered = [], saved = [], selfIp = null, autoTimer = null;

  function logActivity(msg) {
    const el = document.createElement('div');
    el.style.padding = '6px';
    el.style.borderBottom = '1px solid #f0f0f0';
    el.textContent = `${new Date().toLocaleTimeString()} — ${msg}`;
    activityLog.prepend(el);
    if (activityLog.children.length > 200) activityLog.removeChild(activityLog.lastChild);
  }

  async function fetchSelfIp() {
    try {
      const r = await fetch('/api/my_ip');
      if (!r.ok) return;
      const j = await r.json();
      selfIp = j.ip;
      selfIpEl.textContent = 'You: ' + selfIp;
    } catch (e) {
      selfIpEl.textContent = 'You: (unknown)';
    }
  }

  async function scanOnce(showLog=true) {
    try {
      if (showLog) logActivity('Scanning network...');
      await fetch('/api/discover_now');
      await new Promise(r => setTimeout(r, 600));
      const devRes = await fetch('/api/devices');
      const devJson = await devRes.json();
      discovered = devJson.devices || [];
      const savedRes = await fetch('/api/saved_mesh');
      const savedJson = await savedRes.json();
      saved = savedJson.saved || [];
      renderList();
      if (showLog) logActivity(`Scan complete — devices: ${discovered.length}, saved: ${saved.length}`);
    } catch (e) {
      logActivity('Scan failed: ' + (e.message || e));
    }
  }

  function formatLastSeen(ts) {
    const s = (Date.now()/1000) - ts;
    if (s < 2) return 'just now';
    if (s < 60) return Math.round(s) + 's ago';
    if (s < 3600) return Math.round(s/60) + 'm ago';
    return Math.round(s/3600) + 'h ago';
  }

  function renderList() {
    deviceListEl.innerHTML = '';
    const q = (filterInput.value || '').trim().toLowerCase();
    knownCount.textContent = 'Known: ' + discovered.length;
    savedCount.textContent = 'Saved: ' + saved.length;

    discovered.sort((a,b) => b.last_seen - a.last_seen);

    discovered.forEach(d => {
      const ip = d.ip;
      if (q && !(ip.includes(q) || (d.info && JSON.stringify(d.info).toLowerCase().includes(q)))) return;
      const last = (Date.now()/1000) - d.last_seen;
      const isOnline = last < 8;
      const inSaved = saved.indexOf(ip) !== -1;
      const disabled = (selfIp && ip === selfIp);

      const node = document.createElement('div');
      node.className = 'device';
      node.innerHTML = `
        <div class="row">
          <div style="display:flex; gap:10px; align-items:center;">
            <input type="checkbox" value="${ip}" ${inSaved ? 'checked' : ''} ${disabled ? 'disabled' : ''} />
            <div>
              <div class="ip">${ip} ${disabled ? '<small style="color:#999">(this device)</small>' : ''}</div>
              <div class="meta">${d.info ? JSON.stringify(d.info) : ''}</div>
            </div>
          </div>
          <div style="text-align:right;"><div class="badge ${isOnline ? 'online' : 'offline'}">${isOnline ? 'Online' : 'Offline'}</div></div>
        </div>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px;">
          <div style="color:#666">Last: <b>${formatLastSeen(d.last_seen)}</b></div>
          <div style="display:flex; gap:8px;">
            <button class="btn" data-action="info" data-ip="${ip}">Info</button>
            <button class="btn ${inSaved ? 'btn-primary' : ''}" data-action="toggle" data-ip="${ip}" ${disabled ? 'disabled' : ''}>${inSaved ? 'Saved' : 'Add'}</button>
          </div>
        </div>
      `;
      deviceListEl.appendChild(node);
    });

    // attach handlers
    document.querySelectorAll('[data-action="toggle"]').forEach(btn=>{
      btn.onclick = ()=>{
        const ip = btn.dataset.ip;
        if (saved.indexOf(ip) === -1) saved.push(ip);
        else saved = saved.filter(x=>x!==ip);
        renderList();
      };
    });
    document.querySelectorAll('[data-action="info"]').forEach(btn=>{
      btn.onclick = ()=>{
        const ip = btn.dataset.ip;
        alert('Device info: ' + JSON.stringify(discovered.find(dd=>dd.ip===ip) || {}));
      };
    });
  }

  // event bindings
  document.getElementById('btnScan').addEventListener('click', ()=> scanOnce(true));
  document.getElementById('btnSave').addEventListener('click', async ()=>{
    const selected = [...document.querySelectorAll('#deviceList input[type=checkbox]:checked')].map(i=>i.value);
    const filtered = selected.filter(ip => ip && ip !== selfIp);
    try {
      const res = await fetch('/api/save_mesh_devices', {
        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({devices: filtered})
      });
      const j = await res.json();
      if (j.success) {
        saved = j.saved || filtered;
        logActivity('Saved mesh: ' + saved.join(', '));
        renderList();
      } else {
        logActivity('Save failed: ' + (j.message||'unknown'));
        alert('Save failed: ' + (j.message||'unknown'));
      }
    } catch (e) {
      logActivity('Save error: ' + (e.message || e));
      alert('Save error: ' + (e.message || e));
    }
  });

  document.getElementById('btnSelectAll').addEventListener('click', ()=> {
    document.querySelectorAll('#deviceList input[type=checkbox]:not(:disabled)').forEach(cb=>cb.checked = true);
  });
  document.getElementById('btnClear').addEventListener('click', ()=> {
    document.querySelectorAll('#deviceList input[type=checkbox]').forEach(cb=>cb.checked = false);
  });

  filterInput.addEventListener('input', ()=> renderList());

  const autoCheckbox = document.getElementById('autoRefresh');
  autoCheckbox.addEventListener('change', ()=> toggleAuto(autoCheckbox.checked));

  function toggleAuto(enable) {
    if (autoTimer) { clearInterval(autoTimer); autoTimer = null; }
    if (enable) autoTimer = setInterval(()=> scanOnce(false), 3000);
  }

  // init on DOM ready
  document.addEventListener('DOMContentLoaded', async ()=>{
    await fetchSelfIp();
    await scanOnce(true);
    toggleAuto(autoCheckbox.checked);
  });

})();
</script>
{% endblock %}
