<!DOCTYPE html>
<html>
<head>
  <title>System Diagnostic</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/static/css/styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root{
      --sb-inset-right: 36px;
      --sb-width: 22px;
      --sb-radius: 12px;
      --sb-track: rgba(0,0,0,0.06);
      --sb-thumb: #bfbfbf;
      --sb-min-thumb: 48px;
    }

    html, body { margin:0; height:100%; background:#f9f6ef; overflow:hidden; }

    /* ---- Shared header (same as other pages) ---- */
    .header{
      display:flex; align-items:center; justify-content:space-between;
      padding:18px 38px 0; min-height:60px; box-sizing:border-box;
    }
    .logo-main{ height:44px; display:block; }
    .logo-right{ height:34px; display:block; }
    .menu-back-btn{
      background:#eee; color:#205081; padding:9px 18px; font-size:1rem;
      border:none; border-radius:8px; font-weight:600; cursor:pointer;
      transition:background .16s; min-width:92px; margin-right:12px;
    }
    .menu-back-btn:hover{ background:#ffa500; color:#fff; }

    /* Scrollable area below header */
    .scroll-area{
      position:relative; width:100%; height:calc(100vh - 90px);
      overflow-y:auto; overscroll-behavior:contain;
    }

    /* Center your content */
    .form-section{
      background:#fff; border-radius:16px; box-shadow:0 4px 18px rgba(32,80,129,0.10);
      max-width:440px; margin:36px auto 24px auto; padding:36px 36px 32px 36px; text-align:center;
    }
    .btn-main{ background:#205081; color:#fff; font-size:1.08rem; margin:16px 0; padding:12px 32px; border:none; border-radius:8px; font-weight:600; }
    .btn-main:hover{ background:#ffa500; }
    #diag-results{ margin-top:22px; text-align:left; font-size:1.10rem; }
    .diag-ok{ color:#17a950; font-weight:600; }
    .diag-fail{ color:#d12b3c; font-weight:600; }
    .result-row{ margin-bottom:12px; }
    .diag-summary{ margin-top:22px; font-weight:bold; font-size:1.13rem; }
    .diag-note{ margin-top:13px; color:#444; font-size:1rem; background:#f3eddd; border-radius:8px; padding:9px; }

    /* ===== Inset custom scrollbar ===== */
    .sb-track{
      position:fixed; right:var(--sb-inset-right); width:var(--sb-width);
      top:90px; height:calc(100vh - 90px); z-index:9999;
      background:var(--sb-track); border-radius:var(--sb-radius); box-sizing:border-box;
      display:block;
    }
    .sb-thumb{
      position:absolute; left:2px; right:2px; top:0;
      height:80px; background:var(--sb-thumb); border-radius:calc(var(--sb-radius) - 2px);
      box-shadow:0 1px 2px rgba(0,0,0,0.25);
      cursor:grab; touch-action:none;
    }
    .sb-thumb:active{ cursor:grabbing; }
  </style>
</head>
<body>
  <!-- Header (same pattern as Register/Import/Export/Settings) -->
  <div class="header" id="pageHeader">
    <div class="left">
      <button class="menu-back-btn" onclick="window.location.href='/menu'">← Menu</button>
    </div>
    <div style="flex:1; display:flex; align-items:center; justify-content:center;">
      <img src="/static/img/logo_company.png" class="logo-main" alt="Ethos Logo">
    </div>
    <div class="right">
      <img src="/static/img/logo_epitage.png" class="logo-right" alt="Epitage">
    </div>
  </div>

  <!-- Scrollable area (content stays centered) -->
  <div class="scroll-area" id="scrollArea">
    <div class="form-section">
      <h2>System Diagnostic</h2>
      <button class="btn-main" onclick="runDiagnostic()" id="diag-btn">
        <i class="fa fa-stethoscope"></i> Run Diagnostic Test
      </button>
      <div id="diag-results"></div>
    </div>
  </div>

  <!-- Inset scrollbar UI -->
  <div class="sb-track" id="sbTrack" aria-hidden="true">
    <div class="sb-thumb" id="sbThumb"></div>
  </div>

  <script>
    // ===== Inset scrollbar logic (always visible; syncs with scroll) =====
    (function(){
      const area  = document.getElementById('scrollArea');
      const head  = document.getElementById('pageHeader');
      const track = document.getElementById('sbTrack');
      const thumb = document.getElementById('sbThumb');

      let dragging = false, startY = 0, startScrollTop = 0;

      function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

      function layout(){
        const hb = Math.ceil(head.getBoundingClientRect().bottom);
        const h  = window.innerHeight - hb;
        track.style.top = hb + 'px';
        track.style.height = h + 'px';
        area.style.height = h + 'px';
        refreshThumb();
      }

      function refreshThumb(){
        const trackH    = track.clientHeight;
        const maxScroll = Math.max(0, area.scrollHeight - area.clientHeight);

        let ratio   = area.clientHeight / (area.scrollHeight || 1);
        let tMin    = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--sb-min-thumb')) || 48;
        let tHeight = Math.round(trackH * ratio);
        if (maxScroll <= 0) { tHeight = trackH; }
        tHeight = clamp(tHeight, tMin, trackH);

        thumb.style.height = tHeight + 'px';
        const maxTop   = trackH - tHeight;
        const tTop     = maxScroll ? (area.scrollTop / maxScroll) * maxTop : 0;
        thumb.style.transform = 'translateY(' + tTop + 'px)';
      }

      thumb.addEventListener('pointerdown', (e)=>{
        dragging = true;
        thumb.setPointerCapture(e.pointerId);
        startY = e.clientY;
        startScrollTop = area.scrollTop;
        e.preventDefault();
      });
      thumb.addEventListener('pointermove', (e)=>{
        if(!dragging) return;
        const trackH    = track.clientHeight;
        const tH        = thumb.offsetHeight;
        const maxTop    = Math.max(1, trackH - tH);
        const maxScroll = Math.max(1, area.scrollHeight - area.clientHeight);
        const dY        = e.clientY - startY;
        const perPixel  = maxScroll / maxTop;
        area.scrollTop  = clamp(startScrollTop + dY * perPixel, 0, maxScroll);
      });
      function endDrag(e){
        if(!dragging) return;
        dragging = false;
        try{ thumb.releasePointerCapture(e.pointerId); }catch(_){}
      }
      thumb.addEventListener('pointerup', endDrag);
      thumb.addEventListener('pointercancel', endDrag);
      thumb.addEventListener('lostpointercapture', ()=> dragging = false);

      track.addEventListener('pointerdown', (e)=>{
        if (e.target !== track) return;
        const rect   = track.getBoundingClientRect();
        const clickY = e.clientY - rect.top;
        const tH     = thumb.offsetHeight;
        const trackH = track.clientHeight;
        const maxTop = Math.max(1, trackH - tH);
        const maxScr = Math.max(1, area.scrollHeight - area.clientHeight);
        const tgtTop = clamp(clickY - tH/2, 0, maxTop);
        area.scrollTop = (tgtTop / maxTop) * maxScr;
      });

      area.addEventListener('scroll', refreshThumb, { passive:true });
      window.addEventListener('resize', layout);
      window.addEventListener('load', layout);
      setTimeout(layout, 300);
    })();

    // ===== Your existing diagnostic fetch =====
    async function runDiagnostic() {
      const btn = document.getElementById("diag-btn");
      const out = document.getElementById("diag-results");
      btn.disabled = true;
      out.innerHTML = "<i>Running full hardware/software diagnostic...</i>";

      try {
        const resp = await fetch("/api/diagnostic");
        const data = await resp.json();
        let html = "", passed = 0, failed = 0;

        if (data.results && Array.isArray(data.results)) {
          data.results.forEach((res) => {
            // SKIP camera row if you never want to show it:
            if (/^Camera/.test(res.name)) return;

            html += `<div class="result-row">
              ${res.ok ? "✅ <span class='diag-ok'>" : "❌ <span class='diag-fail'>"}${res.name}</span><br>
              <span style="font-weight:400;color:#555;">${res.info ?? ""}</span>
            </div>`;
            if (res.ok) passed++; else failed++;
          });
        } else {
          html = "<div class='diag-fail'>No results or error occurred.</div>";
        }

        html += `<div class="diag-summary">${passed} check${passed!==1?"s":""} passed, ${failed} failed.</div>`;
        html += `<div class="diag-note">
          <b>Note:</b> For outputs like <b>LED, printer, speaker</b>, the system can only verify communication.<br>
          Please <b>check physically</b> (LED blink, test sound, printer action) to fully confirm wiring.
        </div>`;

        out.innerHTML = html;
      } catch (e) {
        out.innerHTML = `<div class="diag-fail">Diagnostic failed: ${e.message}</div>`;
      } finally {
        document.getElementById("diag-btn").disabled = false;
      }
    }
  </script>
</body>
</html>
