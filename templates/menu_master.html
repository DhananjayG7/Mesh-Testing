{% extends "base.html" %}

{% block title %}Menu Master{% endblock %}

{% block page_css %}
body { background:#f9f6ef; font-family:sans-serif;}
.header { display:flex; align-items:center; justify-content:space-between; padding: 18px 32px 0 32px; }
.logo-main { height: 44px; }
.logo-right { height: 34px; }
.container { max-width:600px; margin:40px auto; background:#fff; border-radius:18px; box-shadow:0 4px 24px #20508122; padding:38px 36px 32px 36px;}
h2 { color:#205081; font-weight:700; margin-bottom:28px;}
form label {display:inline-block; width:100px; margin-bottom:8px; color:#205081; font-weight:600;}
form input,form select {width: calc(100% - 110px); margin-bottom:13px; padding:7px 12px; border-radius:8px; border:1px solid #d0dbed;}
form { display: flex; flex-wrap: wrap; align-items:center; margin-bottom:22px;}
form label, form input, form select, form button { margin-right:10px;}
.btn-main { background:#205081; color:#fff; border:none; border-radius:8px; font-weight:600; padding:9px 18px; margin-right:8px; cursor:pointer;}
.btn-main:hover { background:#ffa500; color:#fff;}
.btn-reset { background:#e3e6f0; color:#205081; border:none; border-radius:8px; font-weight:600; padding:9px 16px; cursor:pointer;}
table { width:100%; margin-top:10px; border-collapse:collapse;}
th,td {padding:9px 11px; border-bottom:1.5px solid #f0f0f0; text-align:center;}
th { background:#f4f8fb; color:#205081;}
td button { margin: 0 4px; }
@media (max-width:600px){
  .container {padding: 18px 5vw;}
  form label, form input, form select {width:100%;}
}
{% endblock %}

{% block body %}
<div class="header">
  <button class="btn btn-main" onclick="location.href='/menu'"><i class="fa fa-arrow-left"></i></button>
  <img src="/static/img/logo_company.png" class="logo-main" alt="Logo">
  <img src="/static/img/logo_epitage.png" class="logo-right" alt="Epitage">
</div>

<div class="container">
  <h2>Menu Master</h2>
  <form onsubmit="return false;" id="menu-form">
    <label>Slot</label>
    <select id="slot_sel"></select>

    <label>Menu Code</label>
    <input id="menu_code" type="text" inputmode="latin" required maxlength="16">

    <label>Menu Name</label>
    <input id="menu_name" type="text" required>

    <button class="btn-main" onclick="addOrUpdateMenu()">Save</button>
    <button class="btn-reset" onclick="resetForm()" type="button">Reset</button>
  </form>

  <table id="menu_table">
    <thead><tr><th>Code</th><th>Name</th><th>Slot</th><th>Action</th></tr></thead>
    <tbody></tbody>
  </table>
</div>
{% endblock %}

{% block scripts %}
<script>
let menus=[],slots=[],edit_code=null;

function load() {
  fetch('/api/menu_master/list').then(r=>r.json()).then(data=>{
    menus = data.menus || [];
    slots = data.slots || [];

    const slot_sel = document.getElementById('slot_sel');
    slot_sel.innerHTML = slots.map(s=>`<option value="${s.slot_code}">${s.slot_name}</option>`).join('');

    const tbody = document.querySelector("#menu_table tbody");
    tbody.innerHTML = menus.map(x=>`<tr>
      <td>${x.menu_code}</td>
      <td>${x.menu_name}</td>
      <td>${(slots.find(s=>s.slot_code==x.slot_code)||{}).slot_name||''}</td>
      <td>
        <button class="btn-main" onclick="edit('${x.menu_code}')">Edit</button>
        <button class="btn-reset" onclick="delMenu('${x.menu_code}')">Delete</button>
      </td>
    </tr>`).join('');
  });
}

function addOrUpdateMenu() {
  const body = {
    menu_code: document.getElementById('menu_code').value.trim(),
    slot_code: document.getElementById('slot_sel').value,
    menu_name: document.getElementById('menu_name').value.trim()
  };
  const url = edit_code ? "/api/menu_master/update" : "/api/menu_master/add";
  if (edit_code) body.menu_code = edit_code;

  fetch(url, {
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(body)
  }).then(()=>{
    edit_code=null;
    load();
    resetForm();
  });
}

function edit(code) {
  const x = menus.find(s=>s.menu_code==code);
  if (!x) return;
  document.getElementById('menu_code').value = x.menu_code;
  document.getElementById('menu_code').readOnly = true;
  document.getElementById('menu_name').value = x.menu_name;
  document.getElementById('slot_sel').value = x.slot_code;
  edit_code = x.menu_code;
}

function delMenu(code) {
  if (!confirm("Delete this menu?")) return;
  fetch("/api/menu_master/delete", {
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({menu_code: code})
  }).then(()=>load());
}

function resetForm() {
  document.getElementById('menu-form').reset();
  document.getElementById('menu_code').readOnly = false;
  edit_code = null;
}

window.onload = load;
</script>
{% endblock %}
